<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org" lang="en">
<head th:replace="layout/layout :: head"></head>
<body style="background-image: linear-gradient(to right, #5c5f62, #53565a, #494e52, #40454a, #373d42);">

<header th:replace="layout/layout :: header"></header>

	<div class="container py-4 text-white">
		<div class="card border-white" style="background: linear-gradient(to right, #2980b9, #2c3e50);">
			<div class="card-header" th:text="${titulo}"></div>
			<div class="card-body">

				<form class="row g-3" th:action="@{/requerimientos/editar/{path}(path=${requerimiento.requerimiento})}"
					th:object="${requerimiento}" method="post">
					<h4 class="card-title text-end pb-2">
						<a class="btn btn-outline-light"
						   th:href="@{'/requerimientos/listar-requerimientos'}"
						   th:text="'&laquo; Volver'"></a>
						<button id="btnSaveRequirement" class="btn btn-success" type="submit"
								th:utext="#{form.requirement.save.button.label}"></button>
					</h4>

					<div class="form-group row py-2">
						<label class="col-sm-2 col-form-label" th:text="Requerimiento"></label>
						<div class="col-sm-2">
							<input type="text" th:field="*{requerimiento}"
								   class="form-control" th:errorclass="'form-control is-invalid'" />
							<div class="invalid-feedback"
								 th:if="${#fields.hasErrors('requerimiento')}"
								 th:errors="*{requerimiento}"></div>
						</div>
						<label class="col-sm-2 col-form-label text-end" th:text="Aplicación"></label>
						<div class="col-sm-2">
							<select class="form-select" th:field="*{aplicacion}" id="aplicacion" name="aplicacion" th:errorclass="'form-control is-invalid'">
								<option value="">Seleccionar...</option>
								<option th:each="aplicacion : ${T(com.workschedule.app.enums.Aplicacion).values()}"
										th:text="${aplicacion.name()}"
										th:value="${aplicacion}">
								</option>
							</select>
							<div class="invalid-feedback"
								 th:if="${#fields.hasErrors('aplicacion')}"
								 th:errors="*{aplicacion}">
							</div>

						</div>
						<label class="col-sm-2 col-form-label text-end" th:text="Estado"></label>
						<div class="col-sm-2">
							<select class="form-select" th:field="*{estado}" id="estado" name="estado" th:errorclass="'form-control is-invalid'">
								<option value="">Seleccionar...</option>
								<option th:each="estado : ${T(com.workschedule.app.enums.EstadoRequerimiento).values()}"
										th:text="${estado}"
										th:value="${estado.name()}">
								</option>
							</select>
							<div class="invalid-feedback"
								 th:if="${#fields.hasErrors('estado')}"
								 th:errors="*{estado}">
							</div>
						</div>
					</div>

					<div class="form-group row py-2">
						<label class="col-sm-2 col-form-label" th:text="Descripción"></label>
						<div class="col-sm-6">
							<input type="text" th:field="*{descripcion}" class="form-control"
								   th:errorclass="'form-control is-invalid'" />
							<div class="invalid-feedback"
								 th:if="${#fields.hasErrors('descripcion')}"
								 th:errors="*{descripcion}"></div>
						</div>
					</div>

			<div class="form-group row padding-top-1">
				<label class="col-sm-2 col-form-label" th:text="Observaciones"></label>
				<div class="col-sm-6">
					<textarea th:field="*{observacion}" rows="" class="form-control"></textarea>
				</div>
			</div>

			<div class="form-group row py-3">
				<label class="col-sm-2 col-form-label" th:utext="#{form.requirement.date.planned.testing}"></label>
				<div class="col-sm-2">
					<input id="fechaPlanifTesting" type="date" data-date="" data-date-format="dd-MM-yyyy" value="${currentDate}" th:field="*{fechaPlanifTesting}" class="form-control"
						   th:errorclass="'form-control is-invalid'" />
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('fechaPlanifTesting')}"
						 th:errors="*{fechaPlanifTesting}"></div>
				</div>
				<label class="col-sm-2 col-form-label" th:utext="#{form.requirement.date.real.testing}"></label>
				<div class="col-sm-2">
					<input id="fechaRealTesting" type="date" data-date="" data-date-format="dd-MM-yyyy" value="${currentDate}" th:field="*{fechaRealTesting}" />
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('fechaRealTesting')}"
						 th:errors="*{fechaRealTesting}"></div>
				</div>
				<label class="col-sm-2" style="font-size:15px;" th:utext="#{form.requirement.reason.replanning.testing}"></label>
				<div class="col-sm-2">
					<select class="form-select" name="motivoReplanifTesting" id="motivoReplanifTesting" th:field="*{motivoReplanifTesting}" >
						<option value="empty">Seleccionar...</option>
						<option th:each="motivoReplanifTesting : ${T(com.workschedule.app.enums.MotivoReplanificacion).values()}"
								th:text="${motivoReplanifTesting}"
								th:value="${motivoReplanifTesting}">
						</option>
					</select>
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('motivoReplanifTesting')}"
						 th:errors="*{motivoReplanifTesting}">
					</div>
				</div>
			</div>

			<div class="form-group row py-3">
				<label class="col-sm-2" th:utext="#{form.requirement.date.planned.imple}"></label>
				<div class="col-sm-2">
					<input id="fechaPlanifImplementacion" name="fechaPlanifImplementacion" type="date" data-date="" data-date-format="dd-MM-yyyy" value="${currentDate}" th:field="*{fechaPlanifImplementacion}">
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('fechaPlanifImplementacion')}"
						 th:errors="*{fechaPlanifImplementacion}"></div>
				</div>
				<label class="col-sm-2 col-form-label" th:utext="#{form.requirement.date.real.imple}"></label>
				<div class="col-sm-2">
					<input id="fechaRealImplementacion" name="fechaRealImplementacion" type="date" data-date="" data-date-format="yyyy-MM-dd" value="${currentDate}" th:field="*{fechaRealImplementacion}">
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('fechaRealImplementacion')}"
						 th:errors="*{fechaRealImplementacion}"></div>
				</div>
				<label class="col-sm-2" style="font-size:15px;" th:utext="#{form.requirement.reason.replanning.imple}"></label>
				<div class="col-sm-2">
					<select class="form-select" name="motivoReplanifImplementacion" id="motivoReplanifImplementacion" th:field="*{motivoReplanifImplementacion}" >
						<option value="empty">Seleccionar...</option>
						<option th:each="motivoReplanifImplementacion : ${T(com.workschedule.app.enums.MotivoReplanificacion).values()}"
								th:text="${motivoReplanifImplementacion}"
								th:value="${motivoReplanifImplementacion}">
						</option>
					</select>
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('motivoReplanifImplementacion')}"
						 th:errors="*{motivoReplanifImplementacion}">
					</div>
				</div>
			</div>

			<div class="form-group row py-3">
				<label class="col-sm-2 col-form-label" th:utext="#{form.requirement.user}"></label>
				<div class="col-sm-2">
					<input id="user" type="text" th:value="${username}" class="form-control" readonly>
				</div>
				<label class="col-sm-2 col-form-label" th:utext="#{form.requirement.type}"></label>
				<div class="col-sm-2">
					<select class="form-select" name="tipoRequerimiento" id="tipoRequerimiento" th:field="*{tipoRequerimiento}" required>
						<option value="empty">Seleccionar...</option>
						<option th:each="tipoRequerimiento : ${T(com.workschedule.app.enums.TipoRequerimiento).values()}"
								th:text="${tipoRequerimiento}"
								th:value="${tipoRequerimiento}">
						</option>
					</select>
					<div class="invalid-feedback"
						 th:if="${#fields.hasErrors('tipoRequerimiento')}"
						 th:errors="*{tipoRequerimiento}">
					</div>
				</div>

			</div>

					<div class="form-group row py-3">
						    <div id="tablaEstimaciones" class="row col-12">
							</div>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" id="new-phase-modal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Agrega una nueva fase</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" id="namePhase" placeholder="Nombre de Fase"/>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
					<button type="button" class="btn btn-primary" onclick="addNewPhase();">Guardar</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" id="alert-modal-info-at-least-one-checked">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="inline">
						<i class="bi bi-info-circle"></i>
						<span class="modal-title info-modal-span">Debes activar al menos una estimación</span>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>

	<footer th:replace="layout/layout :: footer"></footer>
	<script type="text/javascript" th:inline="javascript">
		var estimaciones = [];
		var listVersiones = [];
		var total = 0;
		var boxesChecked = [];
		const allEqual = arr => arr.every( v => v === arr[0] );
		estimaciones = [[${requerimiento.estimacion}]];
		estimaciones.forEach((estimacion)=> {
			listVersiones.push(estimacion.version);
			listVersiones = removeDuplicates(listVersiones);
		});
		listVersiones.forEach((version) => {
			let listEstimacion = estimaciones.filter(function(item){
				return item.version == version;
			});
			addListEstimation(listEstimacion);
		});
		var numEstimaciones = listVersiones[-1];
		const calculateSum = (arr) => {
			return arr.reduce((total, current) => {
				return parseInt(total) + parseInt(current);
			}, 0);
		};

		function removeDuplicates(arr) {
			return arr.filter((item,
							   index) => arr.indexOf(item) === index);
		}

		function addNewPhase() {
			let tbodyIdInsert = sessionStorage.getItem('tbody');
			let tBody = document.getElementById(tbodyIdInsert);
			let valNewPhase = document.getElementById('namePhase');
			let rows = document.getElementById(tbodyIdInsert).rows.length;
			tBody.appendChild(buildFaseNueva(valNewPhase.value, rows + 1));
			let modalEl1 = document.getElementById("new-phase-modal");
			let modal = bootstrap.Modal.getInstance(modalEl1);
			modal.hide();
		}

		/** *
		 Esta función es llamada para borrar toda la tabla de estimacion
		 @param {HTMLElement} that - Este param corresponde al boton de eliminar toda la estimacion
		 * @returns {void} - Devuelve void.
		 */
		function deleteAllEstimation(that) {
			that.parentNode.parentNode.parentNode.parentNode.remove();
		}

		function addListEstimation(listEstimaciones) {
			let tablaDiv = document.getElementById('tablaEstimaciones');
			let tablaActual = document.createElement('table');
			tablaActual.id= "cargarFase";
			tablaActual.tagName="cargarFase";
			tablaActual.title = "Estimacion Tabla";
			tablaActual.className = "table table-sm table-striped table-hover";
			let tHead = document.createElement('thead');
			tHead.className= "text-white";
			let trHeadColumns = document.createElement('tr');

			trHeadColumns.innerHTML = '<th scope="col">Fase</th>' +
					'<th scope="col">Horas</th>' +
					'<th>Eliminar</th>';
			let tBody = document.createElement('tbody');
			tBody.id= 'fasesTable_' + listEstimaciones[0].version;
			listEstimaciones.forEach((estimacion) => {
				tBody.appendChild(buildFase(estimacion.activo, estimacion.fase, estimacion.version, estimacion.cantidadHoras));
			})
			tHead.appendChild(trHeadColumns);
			tablaActual.appendChild(tHead);
			tablaActual.appendChild(tBody);

			let card = document.createElement("div");
			card.className = "card col-6";
			card.id = "card_" + listEstimaciones[0].version;
			card.style.marginTop = "0.625rem";
			card.style.border = "none";
			card.style.paddingLeft= "0";
			card.style.paddingRight = "0";
			card.style.paddingBottom = "0";
			card.style.marginLeft = "0.625rem"
			card.style.marginRight = "0.625rem";
			card.style.width= "30%";
			let cardHeader = document.createElement("div")
			cardHeader.className = "card-header text-white bg-primary mb-3";
			cardHeader.innerHTML = buildHeaderCard(listEstimaciones[0].activo, listEstimaciones[0].version);

			let cardBody = document.createElement("div");
			cardBody.className = "card-body text-white bg-secondary mb-3";
			cardBody.style.maxWidth = "34rem";
			cardBody.style.marginTop = "-0.9rem";

			let sectionActionAddPhase = document.createElement("div");
			sectionActionAddPhase.className = "row";
			sectionActionAddPhase.innerHTML = '<div class="col-sm-2">'+
					'<button type="button" class="btn btn-primary" style="margin-top: -15px;margin-left:15.625rem;" data-bs-toggle="modal" data-bs-target="#new-phase-modal" onclick="persistDataTable(this)"><i data-bs-toggle="tooltip" data-bs-placement="right" title="Agrega una fase" class="bi bi-file-plus"></i></button>'+
					'</div>';

			let sectionActionDelete = document.createElement("div");
			sectionActionDelete.className = "row py-3";
			sectionActionDelete.innerHTML =
					'<div class="col-sm-2">'+
					'<button type="button" class="btn btn-danger btnDelete" style="margin-top: 20px;margin-left: 15.625rem;" href="#" data-bs-toggle="tooltip" data-bs-placement="top" title="Elimina toda la estimación" onclick="deleteAllEstimation(this);"><i class="bi bi-trash3-fill"></i></button>'+
					'</div>';
			cardBody.appendChild(sectionActionAddPhase);
			cardBody.appendChild(tablaActual);
			cardBody.appendChild(sectionActionDelete);
			card.appendChild(cardHeader);
			card.appendChild(cardBody);

			tablaDiv.appendChild(card);

			buildHiddenInput(cardBody,listEstimaciones[0].activo);

			//document.getElementById("longitudEstimaciones").value = $(".horas").length;

		}

		function buildHiddenInput(cardBody, valorActivo){
			cardBody.querySelectorAll('#cantidadHoras')
					.forEach((input) => {
						if(valorActivo === "0") {
							input.setAttribute("disabled", "disabled");
						} else {
							input.removeAttribute("disabled");
						}
						numEstimaciones++;
						let versionLabel = input.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector('label').textContent;
						const versionSplit = versionLabel.split(" ");
						const originalObject = { fase: input.parentNode.parentNode.parentNode.firstChild.textContent, version: parseInt(versionSplit[1]), cantidadHoras: parseInt(input.value), usuarioAlta: [[${username}]], activo: parseInt(valorActivo)};
						const copiedObject = Object.assign({}, originalObject);
						let jsonString = JSON.stringify(copiedObject, null, 2);
						input.nextSibling.value = jsonString;
					});
		}

		function buildHeaderCard(activo, version) {
			let str = '<div>' +
					'<input type="text" value="" placeholder="Nombre estimación" name="namesEstimation[]" class="form-control" />' +
					'<div class="inline">'+ '<label>Version: '+version+'</label>'+
					'<div style="float: right;margin-right: 20px; display:inline-block;">' +
					'<span>Activo  </span>';
			if(activo === 1) {
				str += '<input type="checkbox" id="checkbox1" name="checkbox1" class="onoffswitch-checkbox" onchange="verifyWhenDisabledInput(this);" checked>';
			} else {
				str += '<input type="checkbox" id="checkbox1" name="checkbox1" class="onoffswitch-checkbox" onchange="verifyWhenDisabledInput(this);" >'
			}

			str += '</div>'+ '</div>' + '</div>';
			return str;
		}
		function buildFaseNueva(fase, index) {
			const trFases = document.createElement('tr');
			trFases.id = 'row_' + index;
			let htmlInputs =
					'<td>' + fase + '</td>' +
					'<td>' +
					'<div class="col-xs-2">' +
					'<input type="number" id="cantidadHoras" name="cantidadHoras" class="form-control text-end horas input-size-default" value="0" min="0" onkeydown="if (event.keyCode == 13) { return false;}"/>' +
					'<input type="hidden" id="estimacionHidden" name="estimacionHidden" class="estimacionHidden" />'+
					'</div>' +
					'</td>'+
					'<td><button type="button" class="btn btn-danger btnDelete" href="#" onclick="deletePhase(this)">X</button></td>';
			trFases.innerHTML = htmlInputs;
			trFases.querySelectorAll("#cantidadHoras").forEach((currentInput) => {
				const originalObject = { fase: currentInput.parentNode.parentNode.parentNode.firstChild.textContent, version: parseInt("1"), cantidadHoras: parseInt(currentInput.value), usuarioAlta: [[${username}]], activo: parseInt("0")};
				const copiedObject = Object.assign({}, originalObject);
				let jsonString = JSON.stringify(copiedObject, null, 2);
				currentInput.nextSibling.value = jsonString;
			});
			return trFases;
		}
		function buildFase(activo, fase, version, cantHoras) {
			const horas = cantHoras;
			const trFases = document.createElement('tr');
			trFases.id = 'row_' + version;
			let htmlInputs =
					'<td>' + fase + '</td>' +
					'<td>' +
					'<div class="col-xs-2">';
			if(activo == 1) {
				htmlInputs += '<input type="number" id="cantidadHoras" name="cantidadHoras" value="' + horas + '" min="0" max="30" class="form-control text-end horas input-size-default" onchange="calculateTotal(this);" onkeydown="if (event.keyCode == 13) { return false;}"/>';
			} else {
					htmlInputs +=	'<input type="number" id="cantidadHoras" name="cantidadHoras" value="' + horas + '" min="0" max="30" class="form-control text-end horas input-size-default" onchange="calculateTotal(this);" onkeydown="if (event.keyCode == 13) { return false;}" disabled/>';
			 }

			htmlInputs += '<input type="hidden" id="estimacionHidden" name="estimacionHidden" class="estimacionHidden"/>'+
					      '</div>' +
					      '</td>'+
					      '<td><button type="button" class="btn btn-danger btnDelete" href="#" onclick="deletePhase(this)">X</button></td>';
			trFases.innerHTML = htmlInputs;
			return trFases;
		}

		function deletePhase(that) {
			if(that.parentNode.parentNode.nextSibling == null && that.parentNode.parentNode.previousSibling == null) {
				that.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.remove();
			}
			that.parentNode.parentNode.remove();
		}

		function calculateTotal(that) {
			var elements = $(".horas");
			var arr = [];
			for (var i = 0; i < elements.length; i++) {
				if(isNaN(elements[i].value)) {
					total += 0;
				} else if(elements[i].value.trim() !== "") {
					arr.push(elements[i].value);
				} else {
					total += 0;
				}
			}
			total = calculateSum(arr);
			let obj = JSON.parse(that.nextSibling.value);
			obj.cantidadHoras = that.value;
			that.nextSibling.value = JSON.stringify(obj, null, 2);

		}

		function showModalInfoAtLeastOneChecked() {
			$('#alert-modal-info-at-least-one-checked').modal('show');
		}

		function persistDataTable(that) {
			let tBodyID = that.parentNode.parentNode.parentNode.querySelector('tbody').getAttribute("id");
			sessionStorage.setItem('tbody', tBodyID);
		}

		/** *
		 Esta función verifica que haya solo un checkbox activo y de estar activo descheckea los otros checkbox para que se el unico activo, ademas desabilita los input de cantidad de horas que no tengan este checkbox checkeado
		 * @param {HTMLElement} that - Este param se corresponde al checkbox correspondiente a una card especifica
		 * @returns {void} - Devuelve void.
		 */
		function verifyWhenDisabledInput(that) {
			if(that.checked) {
				document.querySelectorAll('input[type=checkbox]').forEach(function (checkElement) {
					checkElement.checked = false;
				});
				document.querySelectorAll("#cantidadHoras").forEach((input) => {
					input.setAttribute("disabled", "disabled");
				});
				that.parentNode.parentNode.parentNode.parentNode.parentNode.querySelectorAll("#cantidadHoras").forEach(
						(currentInput) => {
							currentInput.removeAttribute("disabled");
						});
				that.checked = true;
			} else {
				document.querySelectorAll('input[type=checkbox]').forEach(function (checkElement) {
					boxesChecked.push(checkElement.checked);
				});
				that.parentNode.parentNode.parentNode.parentNode.parentNode.querySelectorAll("#cantidadHoras").forEach(
						(currentInput) => {
							currentInput.setAttribute("disabled","disabled");
						});
				if(allEqual(boxesChecked)){
					showModalInfoAtLeastOneChecked();
				}
			}

			document.querySelectorAll("#cantidadHoras").forEach(
					(currentInput) => {
						let objEstimacion = JSON.parse(currentInput.nextSibling.value);
						console.log("aca se esta cambiando el valor a cero");
						currentInput.setAttribute("disabled", "");
						objEstimacion.activo = "0";
						currentInput.nextSibling.value = JSON.stringify(objEstimacion, null, 2);
					}
			);

			that.parentNode.parentNode.parentNode.parentNode.parentNode.querySelectorAll("#cantidadHoras").forEach(
					(currentInput) => {
						let objEstimacion = JSON.parse(currentInput.nextSibling.value);
						if(that.checked === true ) {
							console.log("aca se esta cambiando el valor a 1");
							currentInput.removeAttribute("disabled");
							objEstimacion.activo = "1";
						} else {
							console.log("aca se esta cambiando el valor a cero");
							currentInput.setAttribute("disabled", "");
							objEstimacion.activo = "0";
						}
						currentInput.nextSibling.value = JSON.stringify(objEstimacion, null, 2);
					}
			);

		}

	</script>

</body>
</html>